<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Tree_Fitting.utf8.md</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/table1-1.0/table1_defaults.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  { color: #cccccc; background-color: #303030; }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ffcfaf; } /* Alert */
code span.an { color: #7f9f7f; font-weight: bold; } /* Annotation */
code span.at { } /* Attribute */
code span.bn { color: #dca3a3; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #f0dfaf; } /* ControlFlow */
code span.ch { color: #dca3a3; } /* Char */
code span.cn { color: #dca3a3; font-weight: bold; } /* Constant */
code span.co { color: #7f9f7f; } /* Comment */
code span.cv { color: #7f9f7f; font-weight: bold; } /* CommentVar */
code span.do { color: #7f9f7f; } /* Documentation */
code span.dt { color: #dfdfbf; } /* DataType */
code span.dv { color: #dcdccc; } /* DecVal */
code span.er { color: #c3bf9f; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #c0bed1; } /* Float */
code span.fu { color: #efef8f; } /* Function */
code span.im { } /* Import */
code span.in { color: #7f9f7f; font-weight: bold; } /* Information */
code span.kw { color: #f0dfaf; } /* Keyword */
code span.op { color: #f0efd0; } /* Operator */
code span.ot { color: #efef8f; } /* Other */
code span.pp { color: #ffcfaf; font-weight: bold; } /* Preprocessor */
code span.sc { color: #dca3a3; } /* SpecialChar */
code span.ss { color: #cc9393; } /* SpecialString */
code span.st { color: #cc9393; } /* String */
code span.va { } /* Variable */
code span.vs { color: #cc9393; } /* VerbatimString */
code span.wa { color: #7f9f7f; font-weight: bold; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="customstyles.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}


.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}

.tocify-subheader {
  display: inline;
}
.tocify-subheader .tocify-item {
  font-size: 0.95em;
}

</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-inverse  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Data Analysis Exercise Website</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="./author.html">About the Author</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Analyses
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="./Continuous_Outcome_Analysis.html">Continuous Outcome Analysis</a>
    </li>
    <li>
      <a href="./Variable_Selection.html">Variable Selection</a>
    </li>
    <li>
      <a href="./Tree_Fitting.html">Tree Fitting</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Other Exercises
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="./TrangQuach_M3_Coding.html">Coding Exercises</a>
    </li>
    <li>
      <a href="./Visualization.html">Visualization</a>
    </li>
    <li>
      <a href="./Tidytuesday_1.html">TidyTuesday 1</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="URL-TO-THIS-REPOSITORY-HERE">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">




</div>


<div id="overview" class="section level1">
<h1>Overview</h1>
<p>This document will guide you through some data analysis tasks with a focus on fitting tree-based models and training them. We’ll also (re)-visit some other topics.</p>
<p>While this is in some sense a stand-alone analysis, I assume that you have worked through the <em>Data Analysis</em> exercise and are familiar with the dataset and all the things we discovered during the cleaning process. We’ll use the same dataset here but focus on a different outcome. Other than that, the way to work through the exercise is like in the <em>Data Analysis</em> exercise, namely by writing/completing the missing code.</p>
</div>
<div id="project-setup" class="section level1">
<h1>Project setup</h1>
<p>We need a variety of different packages, which are loaded here. Install as needed. For this analysis, we’ll again use the <code>caret</code> package. If you use others, load them here.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="kw">library</span>(<span class="st">&#39;tidyr&#39;</span>)</a>
<a class="sourceLine" id="cb1-2" title="2"><span class="kw">library</span>(<span class="st">&#39;dplyr&#39;</span>)</a>
<a class="sourceLine" id="cb1-3" title="3"><span class="kw">library</span>(<span class="st">&#39;forcats&#39;</span>)</a>
<a class="sourceLine" id="cb1-4" title="4"><span class="kw">library</span>(<span class="st">&#39;ggplot2&#39;</span>)</a>
<a class="sourceLine" id="cb1-5" title="5"><span class="kw">library</span>(<span class="st">&#39;knitr&#39;</span>)</a>
<a class="sourceLine" id="cb1-6" title="6"><span class="kw">library</span>(<span class="st">&#39;caret&#39;</span>)</a>
<a class="sourceLine" id="cb1-7" title="7"><span class="kw">library</span>(<span class="st">&#39;doParallel&#39;</span>)</a>
<a class="sourceLine" id="cb1-8" title="8"><span class="kw">library</span>(<span class="st">&#39;rpart&#39;</span>)</a>
<a class="sourceLine" id="cb1-9" title="9"><span class="kw">library</span>(<span class="st">&#39;rpart.plot&#39;</span>)</a>
<a class="sourceLine" id="cb1-10" title="10"><span class="kw">library</span>(<span class="st">&#39;mda&#39;</span>)</a>
<a class="sourceLine" id="cb1-11" title="11"><span class="kw">library</span>(<span class="st">&#39;ranger&#39;</span>)</a>
<a class="sourceLine" id="cb1-12" title="12"><span class="kw">library</span>(<span class="st">&#39;e1071&#39;</span>)</a>
<a class="sourceLine" id="cb1-13" title="13"><span class="kw">library</span>(visdat)</a>
<a class="sourceLine" id="cb1-14" title="14"><span class="kw">library</span>(varhandle)</a>
<a class="sourceLine" id="cb1-15" title="15"><span class="kw">library</span>(stringr)</a>
<a class="sourceLine" id="cb1-16" title="16"><span class="kw">library</span>(table1)</a>
<a class="sourceLine" id="cb1-17" title="17"><span class="kw">library</span>(mlr)</a></code></pre></div>
</div>
<div id="data-loading-and-cleaning" class="section level1">
<h1>Data loading and cleaning</h1>
<p>We will again use the Norovirus dataset.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1"><span class="co">#Write code that loads the dataset </span></a>
<a class="sourceLine" id="cb2-2" title="2"><span class="co">#You can of course re-use code you wrote in the other file.</span></a>
<a class="sourceLine" id="cb2-3" title="3">data_raw &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;norodata.csv&quot;</span>)</a></code></pre></div>
</div>
<div id="looking-at-the-outcome" class="section level1">
<h1>Looking at the outcome</h1>
<p>For this analysis, we consider as our main outcome of interest the season. This is a categorical outcome with more than 2 categories, something we haven’t looked at before. Because it’s more than 2 categories, a basic logistic model won’t work. Fortunately, tree-based models can deal with multiple categories.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1"><span class="co">#write code to take a look at the outcome variable (season)</span></a>
<a class="sourceLine" id="cb3-2" title="2"><span class="kw">table</span>(data_raw<span class="op">$</span>season)</a></code></pre></div>
<pre><code>## 
##          Fall Spring Summer Winter 
##     67    164    222    126    443</code></pre>
<p>We already knew from previous explorations that some entries do not have a season. We could either code them as “other” and keep them in the model, or remove them. Since it’s hard to see any potential scientific reason why there should be a correlation between an “other” season and some variable, we’ll remove it here.</p>
<p>We also notice that while winter is dominant (makes sense, we know that norovirus is more common in winter), we got a decent number of outbreaks for each season, so we shouldn’t have a problem with (un)balanced data.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1"><span class="co">#write code that removes all observations that have an empty/missing value for season</span></a>
<a class="sourceLine" id="cb5-2" title="2"><span class="co">#then drop the empty level and check that you have 4 categories for season left</span></a>
<a class="sourceLine" id="cb5-3" title="3"></a>
<a class="sourceLine" id="cb5-4" title="4">d &lt;-<span class="st"> </span>data_raw <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb5-5" title="5"><span class="st">  </span><span class="kw">filter</span>(season <span class="op">!=</span><span class="st"> &quot;&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb5-6" title="6"><span class="st">  </span><span class="kw">droplevels</span>()</a>
<a class="sourceLine" id="cb5-7" title="7"></a>
<a class="sourceLine" id="cb5-8" title="8"><span class="kw">table</span>(d<span class="op">$</span>season)</a></code></pre></div>
<pre><code>## 
##   Fall Spring Summer Winter 
##    164    222    126    443</code></pre>
</div>
<div id="selecting-predictors" class="section level1">
<h1>Selecting predictors</h1>
<p>We will pick similar variables as previously, but with some changes. Keep the following variables: <code>Action1, CasesAll, Country, Deaths, EndMonth, GG2C4, Hemisphere, Hospitalizations,  MeanD1, MeanI1, MedianD1, MedianI1, OBYear, Path1, RateAll, RiskAll, Season, Setting, StartMonth, State, Trans1, Vomit.</code></p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1"><span class="co"># write code that retains the above mentioned variables</span></a>
<a class="sourceLine" id="cb7-2" title="2"></a>
<a class="sourceLine" id="cb7-3" title="3">d1 &lt;-<span class="st"> </span>d<span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(Action1, CasesAll, Country, Deaths, EndMonth, gg2c4, Hemisphere, Hospitalizations,  MeanD1, MeanI1, MedianD1, MedianI1, OBYear, Path1, RateAll, RiskAll, season, Setting_<span class="dv">1</span>, StartMonth, State, Trans1, Vomit)</a></code></pre></div>
</div>
<div id="cleaning-predictors" class="section level1">
<h1>Cleaning predictors</h1>
<p>We’ll have to perform the usual cleaning steps. You might have realized by now that even for the same dataset, cleaning steps can differ based on the outcome (and as you see below, the model).</p>
<p>Let’s first check for missing values.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1"><span class="co"># write code that looks at missing values</span></a>
<a class="sourceLine" id="cb8-2" title="2"></a>
<a class="sourceLine" id="cb8-3" title="3"><span class="kw">colSums</span>(<span class="kw">is.na</span>(d1))</a></code></pre></div>
<pre><code>##          Action1         CasesAll          Country           Deaths 
##                0                5                0               42 
##         EndMonth            gg2c4       Hemisphere Hospitalizations 
##                0                0                0               42 
##           MeanD1           MeanI1         MedianD1         MedianI1 
##                0                0                0                0 
##           OBYear            Path1          RateAll          RiskAll 
##                0                0              104              116 
##           season        Setting_1       StartMonth            State 
##                0                0                0                0 
##           Trans1            Vomit 
##                0                1</code></pre>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1"><span class="kw">vis_dat</span>(d1)</a></code></pre></div>
<p><img src="Tree_Fitting_files/figure-html/check-reduced-data-1.png" width="672" /></p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1"><span class="kw">vis_miss</span>(d1, <span class="dt">cluster =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<p><img src="Tree_Fitting_files/figure-html/check-reduced-data-2.png" width="672" /></p>
<p>Looks like none of the new variables we included had a ton of missing, so we would probably be ok just removing any observation that has missing data. <strong>However</strong>, tree-based models can deal with missing data in predictors. Therefore, we’ll keep them for now. We’ll later compare how the model does or does not change if we remove those observations.</p>
<p>Let’s make sure everything has the right format (numeric/integer/factor). Adjust/recode variables as needed. You will likely find that as you convert <code>OBYear</code> to numeric, something doesn’t quite work. Take a look. Fix by removing the observation with the troublesome entry, then convert to numeric. Finally, remove the observations that have 0 as OByear - there are more than 1 now.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1"><span class="co">#write code that cleans OBYear, convert it to numeric. Remove observations with OBYear = 0. </span></a>
<a class="sourceLine" id="cb12-2" title="2"><span class="co">#also convert any other variables as needed</span></a>
<a class="sourceLine" id="cb12-3" title="3"></a>
<a class="sourceLine" id="cb12-4" title="4">d2 &lt;-<span class="st"> </span>d1 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb12-5" title="5"><span class="st">  </span><span class="kw">filter</span>(OBYear <span class="op">!=</span><span class="st"> &quot;2002-2007&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-6" title="6"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">OBYear =</span> <span class="kw">unfactor</span>(OBYear)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-7" title="7"><span class="st">  </span><span class="kw">filter</span>(OBYear <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>)</a>
<a class="sourceLine" id="cb12-8" title="8"> </a>
<a class="sourceLine" id="cb12-9" title="9"><span class="kw">table</span>(d2<span class="op">$</span>OBYear)</a></code></pre></div>
<pre><code>## 
## 1983 1990 1992 1993 1994 1995 1996 1997 1998 1999 2000 2001 2002 2003 2004 
##    1    1    1    6   15    8   10   37   76   80   59   46  134   91  114 
## 2005 2006 2007 2008 2009 2010 
##   66  127   33   15   17   16</code></pre>
<p>Look at the data to see what else we need to do.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" title="1"><span class="kw">str</span>(d2)</a></code></pre></div>
<pre><code>## &#39;data.frame&#39;:    953 obs. of  22 variables:
##  $ Action1         : Factor w/ 4 levels &quot;No&quot;,&quot;Unknown&quot;,..: 3 3 3 3 3 3 3 3 3 4 ...
##  $ CasesAll        : int  15 65 27 4 15 6 40 10 116 45 ...
##  $ Country         : Factor w/ 21 levels &quot;Australia&quot;,&quot;Brazil&quot;,..: 11 21 16 16 16 16 16 16 16 21 ...
##  $ Deaths          : int  0 0 0 0 0 0 0 0 0 0 ...
##  $ EndMonth        : int  12 9 0 0 0 0 0 0 11 11 ...
##  $ gg2c4           : Factor w/ 2 levels &quot;&quot;,&quot;Yes&quot;: 2 1 2 1 2 1 1 1 2 1 ...
##  $ Hemisphere      : Factor w/ 2 levels &quot;Northern&quot;,&quot;Southern&quot;: 1 1 1 1 1 1 1 1 1 1 ...
##  $ Hospitalizations: int  0 0 0 0 0 0 0 0 5 10 ...
##  $ MeanD1          : num  0 0 0 0 0 0 0 0 0 0 ...
##  $ MeanI1          : int  0 0 0 0 0 0 0 0 0 0 ...
##  $ MedianD1        : num  0 36 0 0 0 0 0 0 0 48 ...
##  $ MedianI1        : int  0 37 0 0 0 0 0 0 0 31 ...
##  $ OBYear          : num  1999 1998 2006 2006 2006 ...
##  $ Path1           : Factor w/ 4 levels &quot;No&quot;,&quot;Unknown&quot;,..: 1 1 3 3 3 3 3 3 1 3 ...
##  $ RateAll         : num  0 39.8 20.8 100 60 ...
##  $ RiskAll         : num  0 108 130 4 25 ...
##  $ season          : Factor w/ 4 levels &quot;Fall&quot;,&quot;Spring&quot;,..: 1 1 1 1 1 1 1 1 1 1 ...
##  $ Setting_1       : Factor w/ 374 levels &quot;\tPsychiatric Care Center adjoined&quot;,..: 118 32 39 301 39 341 39 301 196 3 ...
##  $ StartMonth      : int  11 9 9 10 11 11 11 11 11 11 ...
##  $ State           : Factor w/ 36 levels &quot;0&quot;,&quot;1&quot;,&quot;14 states: CA, UT, KS, WI, IL, IN, OH, GA, FL, NC, VA, WV, NY, PA,&quot;,..: 1 21 1 1 1 1 1 1 1 9 ...
##  $ Trans1          : Factor w/ 6 levels &quot;Environmental&quot;,..: 5 2 2 2 2 2 2 2 5 2 ...
##  $ Vomit           : int  1 1 1 1 1 1 1 1 1 1 ...</code></pre>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" title="1"><span class="kw">summary</span>(d2)</a></code></pre></div>
<pre><code>##         Action1       CasesAll          Country        Deaths       
##  No         :  1   Min.   :    1   Other    :397   Min.   :0.00000  
##  Unknown    :  1   1st Qu.:    9   Japan    :371   1st Qu.:0.00000  
##  Unspecified:742   Median :   25   USA      :106   Median :0.00000  
##  Yes        :209   Mean   :  129   Australia: 21   Mean   :0.05379  
##                    3rd Qu.:   64   Multiple : 17   3rd Qu.:0.00000  
##                    Max.   :32150   Denmark  : 11   Max.   :9.00000  
##                    NA&#39;s   :5       (Other)  : 30   NA&#39;s   :42       
##     EndMonth      gg2c4        Hemisphere  Hospitalizations  
##  Min.   : 0.000      :676   Northern:872   Min.   :  0.0000  
##  1st Qu.: 0.000   Yes:277   Southern: 81   1st Qu.:  0.0000  
##  Median : 0.000                            Median :  0.0000  
##  Mean   : 2.559                            Mean   :  0.7113  
##  3rd Qu.: 4.000                            3rd Qu.:  0.0000  
##  Max.   :12.000                            Max.   :125.0000  
##                                            NA&#39;s   :42        
##      MeanD1            MeanI1           MedianD1          MedianI1     
##  Min.   :  0.000   Min.   : 0.0000   Min.   :  0.000   Min.   : 0.000  
##  1st Qu.:  0.000   1st Qu.: 0.0000   1st Qu.:  0.000   1st Qu.: 0.000  
##  Median :  0.000   Median : 0.0000   Median :  0.000   Median : 0.000  
##  Mean   :  1.558   Mean   : 0.7125   Mean   :  2.611   Mean   : 1.703  
##  3rd Qu.:  0.000   3rd Qu.: 0.0000   3rd Qu.:  0.000   3rd Qu.: 0.000  
##  Max.   :273.600   Max.   :48.0000   Max.   :235.200   Max.   :65.000  
##                                                                        
##      OBYear             Path1        RateAll          RiskAll       
##  Min.   :1983   No         :197   Min.   :  0.00   Min.   :    0.0  
##  1st Qu.:2000   Unknown    :  3   1st Qu.:  0.00   1st Qu.:    0.0  
##  Median :2003   Unspecified:675   Median : 16.50   Median :   20.5  
##  Mean   :2002   Yes        : 78   Mean   : 27.04   Mean   :  399.7  
##  3rd Qu.:2005                     3rd Qu.: 49.00   3rd Qu.:  110.8  
##  Max.   :2010                     Max.   :105.00   Max.   :35000.0  
##                                   NA&#39;s   :103      NA&#39;s   :115      
##     season                  Setting_1     StartMonth         State    
##  Fall  :164   Restaurant         :104   Min.   : 0.000   0      :842  
##  Spring:222   0                  : 85   1st Qu.: 2.000   NC     : 18  
##  Summer:125   restaurant         : 70   Median : 5.000   NY     : 10  
##  Winter:442   Hospital           : 39   Mean   : 5.894   AK     :  9  
##               Hotel              : 25   3rd Qu.:10.000   FL     :  7  
##               Nursing Care Center: 25   Max.   :12.000   MI     :  6  
##               (Other)            :605                    (Other): 61  
##               Trans1        Vomit       
##  Environmental   : 11   Min.   :0.0000  
##  Foodborne       :373   1st Qu.:0.0000  
##  Person to Person:150   Median :1.0000  
##  Unknown         : 63   Mean   :0.5074  
##  Unspecified     :284   3rd Qu.:1.0000  
##  Waterborne      : 72   Max.   :1.0000  
##                         NA&#39;s   :1</code></pre>
<p>Some issues we noted previously: We need to remove the <code>Unspecified</code> entry in <code>Hemisphere</code> and recode <code>Action1</code> and <code>Path1</code> as described in the <em>Data Analysis exercise</em>, i.e., from <code>Unknown</code> to <code>Unspecified</code>. Also, we want to group the <code>Setting_1</code> variable into just <code>Restaurant</code> and <code>Other</code>. Again, remember that there are <code>restaurant</code> and <code>Restaurant</code> values, so you need to fix that too.</p>
<p>We’ll also recode the gg2c4 blank entries to “No”. We further note that <code>Action1</code> has a single <code>No</code> entry. Let’s remove that observation to prevent potential problems during cross-validation.</p>
<p>Let’s also lump country together, make 3 categories, Japan, USA, and Other.</p>
<p>As discussed previously, it makes sense to move the Waterborne to the Environmental in the <code>Trans1</code> variable. It also turns out that most outbreaks have no information for state, so best to drop the <code>State</code> variable.</p>
<p>Finally, move the outcome into the first column.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" title="1"><span class="co"># write code that performs the actions described above</span></a>
<a class="sourceLine" id="cb18-2" title="2"><span class="co"># at the end, use the droplevels() command to remove empty factor levels</span></a>
<a class="sourceLine" id="cb18-3" title="3"></a>
<a class="sourceLine" id="cb18-4" title="4">strings &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;Restaurant&#39;</span>, <span class="st">&#39;restaurant&#39;</span>, <span class="st">&#39;Restaruant&#39;</span>)</a>
<a class="sourceLine" id="cb18-5" title="5"></a>
<a class="sourceLine" id="cb18-6" title="6">d3 &lt;-<span class="st"> </span>d2 <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-7" title="7"><span class="st">   </span><span class="co"># Recoding the Setting_1 variable</span></a>
<a class="sourceLine" id="cb18-8" title="8"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">set3 =</span> <span class="kw">as.character</span>(Setting_<span class="dv">1</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-9" title="9"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Setting =</span> <span class="kw">ifelse</span>(<span class="kw">str_detect</span>(set3, <span class="kw">paste</span>(strings, <span class="dt">collapse =</span> <span class="st">&quot;|&quot;</span>)), <span class="st">&#39;Restaurant&#39;</span>,<span class="st">&#39;Others&#39;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-10" title="10"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Setting=</span> <span class="kw">factor</span>(Setting)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-11" title="11"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span><span class="kw">c</span>(Setting_<span class="dv">1</span>, set3)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-12" title="12"><span class="st"> </span><span class="co"># remove obs when Hemisphere is unspecified</span></a>
<a class="sourceLine" id="cb18-13" title="13"><span class="st">  </span><span class="kw">filter</span>(Hemisphere <span class="op">!=</span><span class="st"> &quot;Unspecified&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-14" title="14"><span class="st"> </span><span class="co"># recode the factor level for Action1 and Path1</span></a>
<a class="sourceLine" id="cb18-15" title="15"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Action1 =</span> <span class="kw">fct_collapse</span>(Action1, <span class="dt">Unspecified =</span> <span class="kw">c</span>(<span class="st">&quot;Unknown&quot;</span>,<span class="st">&quot;Unspecified&quot;</span>)),</a>
<a class="sourceLine" id="cb18-16" title="16">         <span class="dt">Path1 =</span> <span class="kw">fct_collapse</span>(Path1, <span class="dt">Unspecified =</span> <span class="kw">c</span>(<span class="st">&quot;Unknown&quot;</span>,<span class="st">&quot;Unspecified&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-17" title="17"><span class="st">  </span><span class="co"># remove obs with Action1 is No</span></a>
<a class="sourceLine" id="cb18-18" title="18"><span class="st">  </span><span class="kw">filter</span>(Action1 <span class="op">!=</span><span class="st"> &#39;No&#39;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-19" title="19"><span class="st">  </span><span class="co"># recode the factor levels for country and Trans1</span></a>
<a class="sourceLine" id="cb18-20" title="20"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Country =</span><span class="kw">fct_lump</span>(Country, <span class="dt">n=</span><span class="dv">3</span>),</a>
<a class="sourceLine" id="cb18-21" title="21">    <span class="dt">Trans1=</span><span class="kw">fct_collapse</span>(Trans1,<span class="dt">Environmental=</span><span class="kw">c</span>(<span class="st">&#39;Environmental&#39;</span>,<span class="st">&#39;Waterborne&#39;</span>)), <span class="dt">Vomit=</span><span class="kw">factor</span>(Vomit)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-22" title="22"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">gg2c4=</span> <span class="kw">ifelse</span>(gg2c4<span class="op">==</span><span class="st">&#39;Yes&#39;</span>,<span class="st">&#39;Yes&#39;</span>,<span class="st">&#39;No&#39;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-23" title="23"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">gg2c4 =</span> <span class="kw">factor</span>(gg2c4)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-24" title="24"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span><span class="kw">c</span>(State)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-25" title="25"><span class="st">  </span><span class="kw">droplevels</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-26" title="26"><span class="st">  </span><span class="kw">select</span>(season, <span class="kw">everything</span>())</a>
<a class="sourceLine" id="cb18-27" title="27"></a>
<a class="sourceLine" id="cb18-28" title="28"><span class="co"># double check to see the changes made</span></a>
<a class="sourceLine" id="cb18-29" title="29"><span class="kw">table1</span>(<span class="op">~</span><span class="st"> </span>Action1<span class="op">+</span>Country<span class="op">+</span>Hemisphere<span class="op">+</span>Path1<span class="op">+</span>Trans1<span class="op">+</span>gg2c4<span class="op">+</span>Setting, <span class="dt">data=</span>d3)</a></code></pre></div>
<div class="Rtable1"><table class="Rtable1">
<thead>
<tr>
<th class='rowlabel firstrow lastrow'></th>
<th class='firstrow lastrow'><span class='stratlabel'>Overall<br><span class='stratn'>(n=952)</span></span></th>
</tr>
</thead>
<tbody>
<tr>
<td class='rowlabel firstrow'><span class='varlabel'>Action1</span></td>
<td class='firstrow'></td>
</tr>
<tr>
<td class='rowlabel'>Unspecified</td>
<td>743 (78.0%)</td>
</tr>
<tr>
<td class='rowlabel lastrow'>Yes</td>
<td class='lastrow'>209 (22.0%)</td>
</tr>
<tr>
<td class='rowlabel firstrow'><span class='varlabel'>Country</span></td>
<td class='firstrow'></td>
</tr>
<tr>
<td class='rowlabel'>Japan</td>
<td>371 (39.0%)</td>
</tr>
<tr>
<td class='rowlabel'>USA</td>
<td>106 (11.1%)</td>
</tr>
<tr>
<td class='rowlabel lastrow'>Other</td>
<td class='lastrow'>475 (49.9%)</td>
</tr>
<tr>
<td class='rowlabel firstrow'><span class='varlabel'>Hemisphere</span></td>
<td class='firstrow'></td>
</tr>
<tr>
<td class='rowlabel'>Northern</td>
<td>872 (91.6%)</td>
</tr>
<tr>
<td class='rowlabel lastrow'>Southern</td>
<td class='lastrow'>80 (8.4%)</td>
</tr>
<tr>
<td class='rowlabel firstrow'><span class='varlabel'>Path1</span></td>
<td class='firstrow'></td>
</tr>
<tr>
<td class='rowlabel'>No</td>
<td>197 (20.7%)</td>
</tr>
<tr>
<td class='rowlabel'>Unspecified</td>
<td>677 (71.1%)</td>
</tr>
<tr>
<td class='rowlabel lastrow'>Yes</td>
<td class='lastrow'>78 (8.2%)</td>
</tr>
<tr>
<td class='rowlabel firstrow'><span class='varlabel'>Trans1</span></td>
<td class='firstrow'></td>
</tr>
<tr>
<td class='rowlabel'>Environmental</td>
<td>83 (8.7%)</td>
</tr>
<tr>
<td class='rowlabel'>Foodborne</td>
<td>373 (39.2%)</td>
</tr>
<tr>
<td class='rowlabel'>Person to Person</td>
<td>150 (15.8%)</td>
</tr>
<tr>
<td class='rowlabel'>Unknown</td>
<td>63 (6.6%)</td>
</tr>
<tr>
<td class='rowlabel lastrow'>Unspecified</td>
<td class='lastrow'>283 (29.7%)</td>
</tr>
<tr>
<td class='rowlabel firstrow'><span class='varlabel'>gg2c4</span></td>
<td class='firstrow'></td>
</tr>
<tr>
<td class='rowlabel'>No</td>
<td>676 (71.0%)</td>
</tr>
<tr>
<td class='rowlabel lastrow'>Yes</td>
<td class='lastrow'>276 (29.0%)</td>
</tr>
<tr>
<td class='rowlabel firstrow'><span class='varlabel'>Setting</span></td>
<td class='firstrow'></td>
</tr>
<tr>
<td class='rowlabel'>Others</td>
<td>764 (80.3%)</td>
</tr>
<tr>
<td class='rowlabel lastrow'>Restaurant</td>
<td class='lastrow'>188 (19.7%)</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" title="1"><span class="kw">head</span>(d3)</a></code></pre></div>
<pre><code>##   season     Action1 CasesAll Country Deaths EndMonth gg2c4 Hemisphere
## 1   Fall Unspecified       15   Japan      0       12   Yes   Northern
## 2   Fall Unspecified       65     USA      0        9    No   Northern
## 3   Fall Unspecified       27   Other      0        0   Yes   Northern
## 4   Fall Unspecified        4   Other      0        0    No   Northern
## 5   Fall Unspecified       15   Other      0        0   Yes   Northern
## 6   Fall Unspecified        6   Other      0        0    No   Northern
##   Hospitalizations MeanD1 MeanI1 MedianD1 MedianI1 OBYear       Path1
## 1                0      0      0        0        0   1999          No
## 2                0      0      0       36       37   1998          No
## 3                0      0      0        0        0   2006 Unspecified
## 4                0      0      0        0        0   2006 Unspecified
## 5                0      0      0        0        0   2006 Unspecified
## 6                0      0      0        0        0   2006 Unspecified
##     RateAll RiskAll StartMonth      Trans1 Vomit    Setting
## 1   0.00000       0         11 Unspecified     1     Others
## 2  39.81481     108          9   Foodborne     1     Others
## 3  20.76923     130          9   Foodborne     1     Others
## 4 100.00000       4         10   Foodborne     1 Restaurant
## 5  60.00000      25         11   Foodborne     1     Others
## 6  75.00000       8         11   Foodborne     1 Restaurant</code></pre>
</div>
<div id="data-visualization" class="section level1">
<h1>Data visualization</h1>
<p>We know our data fairly well by now, so we might not discover much new in any plots, but it’s always good to do them anyway. Let’s create a few plots showing the outcome and the predictors. We’ll start with the continuous predictors. I suggest scatter/box/violin plots with the outcome on the x-axis.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" title="1"><span class="co">#write code that produces plots showing our outcome of interest on the x-axis and each numeric predictor on the y-axis.</span></a>
<a class="sourceLine" id="cb21-2" title="2"><span class="co">#you can use the facet_wrap functionality in ggplot for it, or do it some other way.</span></a>
<a class="sourceLine" id="cb21-3" title="3">season &lt;-<span class="st"> </span>d3<span class="op">$</span>season</a>
<a class="sourceLine" id="cb21-4" title="4">p1 &lt;-<span class="st"> </span>d3 <span class="op">%&gt;%</span><span class="st">  </span><span class="kw">select_if</span>(is.numeric) <span class="op">%&gt;%</span><span class="st">  </span><span class="kw">cbind</span>(season)</a>
<a class="sourceLine" id="cb21-5" title="5"></a>
<a class="sourceLine" id="cb21-6" title="6">p1 <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-7" title="7"><span class="st">  </span><span class="kw">gather</span>(<span class="op">-</span>season,<span class="dt">key =</span> <span class="st">&quot;var&quot;</span>, <span class="dt">value =</span> <span class="st">&quot;value&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb21-8" title="8"><span class="st">            </span><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_boxplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> season, <span class="dt">y=</span>value)) <span class="op">+</span></a>
<a class="sourceLine" id="cb21-9" title="9"><span class="st">            </span><span class="kw">facet_wrap</span>(<span class="op">~</span><span class="st"> </span>var, <span class="dt">scales =</span> <span class="st">&quot;free&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>()</a></code></pre></div>
<pre><code>## Warning: Removed 305 rows containing non-finite values (stat_boxplot).</code></pre>
<p><img src="Tree_Fitting_files/figure-html/plots-1-1.png" width="672" /></p>
<p>Things look ok, apart from the skew in the predictors we discussed previously.</p>
<p>Next, let’s create plots for the categorical variables. You can use, for instance, <code>geom_count</code> for it, or some other representation. If you prefer lots of tables, that’s ok too.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" title="1"><span class="co">#write code that produces plots or tables showing our outcome of interest and each categorical predictor.</span></a>
<a class="sourceLine" id="cb23-2" title="2"></a>
<a class="sourceLine" id="cb23-3" title="3">p2 &lt;-<span class="st"> </span>d3 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select_if</span>(is.factor) </a>
<a class="sourceLine" id="cb23-4" title="4"></a>
<a class="sourceLine" id="cb23-5" title="5">p3 &lt;-<span class="st"> </span>p2 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">gather</span>(<span class="op">-</span>season, <span class="dt">key=</span><span class="st">&quot;var&quot;</span>, <span class="dt">value=</span><span class="st">&quot;value&quot;</span>)</a></code></pre></div>
<pre><code>## Warning: attributes are not identical across measure variables;
## they will be dropped</code></pre>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" title="1">p3 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x=</span>season, <span class="dt">y=</span>value)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_count</span>() <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb25-2" title="2"><span class="st">  </span><span class="kw">facet_wrap</span>( <span class="op">~</span>var, <span class="dt">scales =</span> <span class="st">&quot;free&quot;</span>) <span class="op">+</span><span class="kw">theme_bw</span>()</a></code></pre></div>
<p><img src="Tree_Fitting_files/figure-html/plots-2-1.png" width="672" /></p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" title="1"><span class="kw">table1</span>(<span class="kw">as.formula</span>(<span class="kw">paste</span>(<span class="st">&quot;~&quot;</span>, <span class="kw">paste</span>(<span class="kw">names</span>(p2)), <span class="dt">collapse=</span><span class="st">&quot;+&quot;</span>)) ,<span class="dt">data=</span>p2)</a></code></pre></div>
<div class="Rtable1"><table class="Rtable1">
<thead>
<tr>
<th class='rowlabel firstrow lastrow'></th>
<th class='firstrow lastrow'><span class='stratlabel'>Overall<br><span class='stratn'>(n=952)</span></span></th>
</tr>
</thead>
<tbody>
<tr>
<td class='rowlabel firstrow'><span class='varlabel'>season</span></td>
<td class='firstrow'></td>
</tr>
<tr>
<td class='rowlabel'>Fall</td>
<td>164 (17.2%)</td>
</tr>
<tr>
<td class='rowlabel'>Spring</td>
<td>222 (23.3%)</td>
</tr>
<tr>
<td class='rowlabel'>Summer</td>
<td>125 (13.1%)</td>
</tr>
<tr>
<td class='rowlabel lastrow'>Winter</td>
<td class='lastrow'>441 (46.3%)</td>
</tr>
<tr>
<td class='rowlabel firstrow'><span class='varlabel'>Action1</span></td>
<td class='firstrow'></td>
</tr>
<tr>
<td class='rowlabel'>Unspecified</td>
<td>743 (78.0%)</td>
</tr>
<tr>
<td class='rowlabel lastrow'>Yes</td>
<td class='lastrow'>209 (22.0%)</td>
</tr>
<tr>
<td class='rowlabel firstrow'><span class='varlabel'>Country</span></td>
<td class='firstrow'></td>
</tr>
<tr>
<td class='rowlabel'>Japan</td>
<td>371 (39.0%)</td>
</tr>
<tr>
<td class='rowlabel'>USA</td>
<td>106 (11.1%)</td>
</tr>
<tr>
<td class='rowlabel lastrow'>Other</td>
<td class='lastrow'>475 (49.9%)</td>
</tr>
<tr>
<td class='rowlabel firstrow'><span class='varlabel'>gg2c4</span></td>
<td class='firstrow'></td>
</tr>
<tr>
<td class='rowlabel'>No</td>
<td>676 (71.0%)</td>
</tr>
<tr>
<td class='rowlabel lastrow'>Yes</td>
<td class='lastrow'>276 (29.0%)</td>
</tr>
<tr>
<td class='rowlabel firstrow'><span class='varlabel'>Hemisphere</span></td>
<td class='firstrow'></td>
</tr>
<tr>
<td class='rowlabel'>Northern</td>
<td>872 (91.6%)</td>
</tr>
<tr>
<td class='rowlabel lastrow'>Southern</td>
<td class='lastrow'>80 (8.4%)</td>
</tr>
<tr>
<td class='rowlabel firstrow'><span class='varlabel'>Path1</span></td>
<td class='firstrow'></td>
</tr>
<tr>
<td class='rowlabel'>No</td>
<td>197 (20.7%)</td>
</tr>
<tr>
<td class='rowlabel'>Unspecified</td>
<td>677 (71.1%)</td>
</tr>
<tr>
<td class='rowlabel lastrow'>Yes</td>
<td class='lastrow'>78 (8.2%)</td>
</tr>
<tr>
<td class='rowlabel firstrow'><span class='varlabel'>Trans1</span></td>
<td class='firstrow'></td>
</tr>
<tr>
<td class='rowlabel'>Environmental</td>
<td>83 (8.7%)</td>
</tr>
<tr>
<td class='rowlabel'>Foodborne</td>
<td>373 (39.2%)</td>
</tr>
<tr>
<td class='rowlabel'>Person to Person</td>
<td>150 (15.8%)</td>
</tr>
<tr>
<td class='rowlabel'>Unknown</td>
<td>63 (6.6%)</td>
</tr>
<tr>
<td class='rowlabel lastrow'>Unspecified</td>
<td class='lastrow'>283 (29.7%)</td>
</tr>
<tr>
<td class='rowlabel firstrow'><span class='varlabel'>Vomit</span></td>
<td class='firstrow'></td>
</tr>
<tr>
<td class='rowlabel'>0</td>
<td>469 (49.3%)</td>
</tr>
<tr>
<td class='rowlabel'>1</td>
<td>482 (50.6%)</td>
</tr>
<tr>
<td class='rowlabel lastrow'>Missing</td>
<td class='lastrow'>1 (0.1%)</td>
</tr>
<tr>
<td class='rowlabel firstrow'><span class='varlabel'>Setting</span></td>
<td class='firstrow'></td>
</tr>
<tr>
<td class='rowlabel'>Others</td>
<td>764 (80.3%)</td>
</tr>
<tr>
<td class='rowlabel lastrow'>Restaurant</td>
<td class='lastrow'>188 (19.7%)</td>
</tr>
</tbody>
</table>
</div>
<p>Looks ok. Notice the NA for vomiting. We are ok with that for now.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" title="1"><span class="kw">dim</span>(d3)</a></code></pre></div>
<pre><code>## [1] 952  21</code></pre>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" title="1"><span class="kw">str</span>(d3)</a></code></pre></div>
<pre><code>## &#39;data.frame&#39;:    952 obs. of  21 variables:
##  $ season          : Factor w/ 4 levels &quot;Fall&quot;,&quot;Spring&quot;,..: 1 1 1 1 1 1 1 1 1 1 ...
##  $ Action1         : Factor w/ 2 levels &quot;Unspecified&quot;,..: 1 1 1 1 1 1 1 1 1 2 ...
##  $ CasesAll        : int  15 65 27 4 15 6 40 10 116 45 ...
##  $ Country         : Factor w/ 3 levels &quot;Japan&quot;,&quot;USA&quot;,..: 1 2 3 3 3 3 3 3 3 2 ...
##  $ Deaths          : int  0 0 0 0 0 0 0 0 0 0 ...
##  $ EndMonth        : int  12 9 0 0 0 0 0 0 11 11 ...
##  $ gg2c4           : Factor w/ 2 levels &quot;No&quot;,&quot;Yes&quot;: 2 1 2 1 2 1 1 1 2 1 ...
##  $ Hemisphere      : Factor w/ 2 levels &quot;Northern&quot;,&quot;Southern&quot;: 1 1 1 1 1 1 1 1 1 1 ...
##  $ Hospitalizations: int  0 0 0 0 0 0 0 0 5 10 ...
##  $ MeanD1          : num  0 0 0 0 0 0 0 0 0 0 ...
##  $ MeanI1          : int  0 0 0 0 0 0 0 0 0 0 ...
##  $ MedianD1        : num  0 36 0 0 0 0 0 0 0 48 ...
##  $ MedianI1        : int  0 37 0 0 0 0 0 0 0 31 ...
##  $ OBYear          : num  1999 1998 2006 2006 2006 ...
##  $ Path1           : Factor w/ 3 levels &quot;No&quot;,&quot;Unspecified&quot;,..: 1 1 2 2 2 2 2 2 1 2 ...
##  $ RateAll         : num  0 39.8 20.8 100 60 ...
##  $ RiskAll         : num  0 108 130 4 25 ...
##  $ StartMonth      : int  11 9 9 10 11 11 11 11 11 11 ...
##  $ Trans1          : Factor w/ 5 levels &quot;Environmental&quot;,..: 5 2 2 2 2 2 2 2 5 2 ...
##  $ Vomit           : Factor w/ 2 levels &quot;0&quot;,&quot;1&quot;: 2 2 2 2 2 2 2 2 2 2 ...
##  $ Setting         : Factor w/ 2 levels &quot;Others&quot;,&quot;Restaurant&quot;: 1 1 1 2 1 2 1 2 1 1 ...</code></pre>
<p>At this step, you should have a dataframe containing 952 observations, and 21 variables: 1 outcome, 12 numeric/integer predictors, and 8 factor variables. All variables should have values that are ready for analysis. The outcome should be in the 1st slot.</p>
</div>
<div id="data-splitting" class="section level1">
<h1>Data splitting</h1>
<p>Let’s do data splitting again. Use <code>caret</code> functions (or any other way you like) to split the data into 70/30 train/test portions.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" title="1"><span class="co">#write code that splits data into 70/30 train/test</span></a>
<a class="sourceLine" id="cb31-2" title="2"><span class="co">#call the 2 parts data_train and data_test</span></a>
<a class="sourceLine" id="cb31-3" title="3"><span class="kw">set.seed</span>(<span class="dv">123</span>)</a>
<a class="sourceLine" id="cb31-4" title="4">trainset &lt;-<span class="st"> </span>caret<span class="op">::</span><span class="kw">createDataPartition</span>(<span class="dt">y =</span> d3<span class="op">$</span>season, <span class="dt">p =</span> <span class="fl">0.7</span>, <span class="dt">list =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb31-5" title="5">data_train =<span class="st"> </span>d3[trainset,] </a>
<a class="sourceLine" id="cb31-6" title="6">data_test =<span class="st"> </span>d3[<span class="op">-</span>trainset,] </a></code></pre></div>
</div>
<div id="parallelization" class="section level1">
<h1>Parallelization</h1>
<p>Similar to <code>mlr</code>, <code>caret</code> allows you to use multiple processors at the same time. It is easy to set up, and the few lines below do the trick.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb32-1" title="1">n_cores &lt;-<span class="st"> </span><span class="dv">4</span> <span class="co">#number of cores to use</span></a>
<a class="sourceLine" id="cb32-2" title="2">cl &lt;-<span class="st"> </span><span class="kw">makePSOCKcluster</span>(n_cores)</a>
<a class="sourceLine" id="cb32-3" title="3"><span class="kw">registerDoParallel</span>(cl) <span class="co">#comment out this line if you don&#39;t want parallel computing</span></a></code></pre></div>
</div>
<div id="model-fitting" class="section level1">
<h1>Model fitting</h1>
<p>We’ll now explore fitting and training several tree-based models. We’ll also explore how including/excluding missing values and centering/scaling or not might affect the results.</p>
<div id="a-null-model" class="section level2">
<h2>A null model</h2>
<p>To define a null model, we need to determine what performance measure we want to track. Since we now have a categorical outcome with more than 2 categories, the regular 2x2 table/confusion matrix, and measurements that rely on it don’t quite work, though many of them have versions that go beyond the 2x2 table. To keep things simple, we will use accuracy, which is simply the fraction of correct predictions. It is easy to compute, no matter how many categories we have. The null model still predicts the most frequent category. We can use that as baseline performance.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" title="1"><span class="co">#write code that computes accuracy for a null model that always predicts the most common category</span></a>
<a class="sourceLine" id="cb33-2" title="2">null &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="st">&quot;Winter&quot;</span>, <span class="kw">nrow</span>(d3))</a>
<a class="sourceLine" id="cb33-3" title="3"><span class="kw">measureACC</span>(null, d3<span class="op">$</span>season)</a></code></pre></div>
<pre><code>## [1] 0.4632353</code></pre>
<p>You should find that the null model has an accuracy of around 0.46.</p>
</div>
<div id="single-predictor-models" class="section level2">
<h2>Single predictor models</h2>
<p>Now let’s consider single predictor models, i.e., we’ll fit the outcome to each predictor one at a time to get an idea of the importance of individual predictors. Here, our model will be a tree. I’m actually not so sure if this makes a lot of sense since a “tree” with only one predictor seems a bit silly. But I guess we can try. It’s similar to a 1-predictor GLM.</p>
<p>We’ll also do some parameter tuning here. Looking at the <a href="http://topepo.github.io/caret/available-models.html">caret documentation</a>, we find that the tuning parameter for the <code>rpart</code> model (which is the tree algorithm) is called <code>cp</code>. We could also find that using <code>modelLookup("rpart")</code>. We could either specify a grid of values to try for <code>cp</code> (we’ll use a grid below), or, for a single tuning parameter, <code>caret</code> allows one to set the number of values to try and picks those values automatically. We’ll do the latter approach here.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb35-1" title="1"><span class="co">#There is probably a nicer tidyverse way of doing this. I just couldn&#39;t think of it, so did it this way.</span></a>
<a class="sourceLine" id="cb35-2" title="2"><span class="kw">set.seed</span>(<span class="dv">1111</span>) <span class="co">#makes each code block reproducible</span></a>
<a class="sourceLine" id="cb35-3" title="3">outcomename =<span class="st"> &quot;season&quot;</span></a>
<a class="sourceLine" id="cb35-4" title="4">fitControl &lt;-<span class="st"> </span><span class="kw">trainControl</span>(<span class="dt">method=</span><span class="st">&quot;repeatedcv&quot;</span>,<span class="dt">number=</span><span class="dv">5</span>,<span class="dt">repeats=</span><span class="dv">5</span>) <span class="co">#setting CV method for caret</span></a>
<a class="sourceLine" id="cb35-5" title="5">Npred &lt;-<span class="st"> </span><span class="kw">ncol</span>(data_train)<span class="op">-</span><span class="dv">1</span> <span class="co"># number of predictors</span></a>
<a class="sourceLine" id="cb35-6" title="6">resultmat &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">Variable =</span> <span class="kw">names</span>(data_train)[<span class="op">-</span><span class="dv">1</span>], <span class="dt">Accuracy =</span> <span class="kw">rep</span>(<span class="dv">0</span>,Npred)) <span class="co">#store performance for each variable</span></a>
<a class="sourceLine" id="cb35-7" title="7"><span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">2</span><span class="op">:</span><span class="kw">ncol</span>(data_train)) <span class="co">#loop over each predictor. For this to work, outcome must be in 1st column</span></a>
<a class="sourceLine" id="cb35-8" title="8">{</a>
<a class="sourceLine" id="cb35-9" title="9">  fit1 &lt;-<span class="st"> </span>caret<span class="op">::</span><span class="kw">train</span>( <span class="kw">as.formula</span>(<span class="kw">paste</span>(outcomename, <span class="st">&quot;~&quot;</span>,<span class="kw">names</span>(data_train)[n])) , <span class="dt">data =</span> data_train, <span class="dt">method =</span> <span class="st">&quot;rpart&quot;</span>, <span class="dt">trControl =</span> fitControl, <span class="dt">na.action =</span> na.pass, <span class="dt">tuneLength =</span> <span class="dv">10</span>) </a>
<a class="sourceLine" id="cb35-10" title="10">resultmat[n<span class="dv">-1</span>,<span class="dv">2</span>]=<span class="st"> </span><span class="kw">max</span>(fit1<span class="op">$</span>results<span class="op">$</span>Accuracy)  </a>
<a class="sourceLine" id="cb35-11" title="11">}</a>
<a class="sourceLine" id="cb35-12" title="12"><span class="kw">print</span>(resultmat)</a></code></pre></div>
<pre><code>##            Variable  Accuracy
## 1           Action1 0.4625783
## 2          CasesAll 0.4371258
## 3           Country 0.4523908
## 4            Deaths 0.4625782
## 5          EndMonth 0.6078051
## 6             gg2c4 0.4625783
## 7        Hemisphere 0.4562893
## 8  Hospitalizations 0.4607826
## 9            MeanD1 0.4631575
## 10           MeanI1 0.4649637
## 11         MedianD1 0.4577710
## 12         MedianI1 0.4548254
## 13           OBYear 0.4787562
## 14            Path1 0.4625805
## 15          RateAll 0.4574609
## 16          RiskAll 0.4661742
## 17       StartMonth 0.8921997
## 18           Trans1 0.4556872
## 19            Vomit 0.4625847
## 20          Setting 0.4625804</code></pre>
<p>So it looks like most of the single predictor models don’t have accuracy much better than the null. 2 exceptions are <code>StartMonth</code> and <code>EndMonth</code>. Well, we would expect that the outbreak season and the month at which the outbreak started (and ended) have a strong correlation. I kept those variables here to see if that would happen and get some reassurance that our model works ok. Of course, in a real analysis, keeping those seems silly, we wouldn’t learn much from it (other than data entry appeared to have been done ok).</p>
</div>
</div>
<div id="full-model" class="section level1">
<h1>Full model</h1>
<p>Anyway, now let’s fit a tree to the full model with all predictors.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb37-1" title="1"><span class="kw">set.seed</span>(<span class="dv">1111</span>) <span class="co">#makes each code block reproducible</span></a>
<a class="sourceLine" id="cb37-2" title="2">fitControl &lt;-<span class="st"> </span><span class="kw">trainControl</span>(<span class="dt">method=</span><span class="st">&quot;repeatedcv&quot;</span>,<span class="dt">number=</span><span class="dv">5</span>,<span class="dt">repeats=</span><span class="dv">5</span>) </a>
<a class="sourceLine" id="cb37-3" title="3">fit1 =<span class="st"> </span>caret<span class="op">::</span><span class="kw">train</span>(season  <span class="op">~</span><span class="st"> </span>., <span class="dt">data=</span>data_train, <span class="dt">method=</span><span class="st">&quot;rpart&quot;</span>,  <span class="dt">trControl =</span> fitControl, <span class="dt">na.action =</span> na.pass, <span class="dt">tuneLength =</span> <span class="dv">10</span>) </a>
<a class="sourceLine" id="cb37-4" title="4"><span class="kw">print</span>(fit1<span class="op">$</span>results)</a></code></pre></div>
<pre><code>##            cp  Accuracy     Kappa AccuracySD    KappaSD
## 1  0.00000000 0.9733450 0.9608083 0.01419000 0.02099063
## 2  0.02135562 0.9727480 0.9598555 0.01463699 0.02178684
## 3  0.04271123 0.9248201 0.8900274 0.02820307 0.04147341
## 4  0.06406685 0.8921723 0.8424778 0.02326732 0.03397198
## 5  0.08542247 0.8921723 0.8424778 0.02326732 0.03397198
## 6  0.10677809 0.8921723 0.8424778 0.02326732 0.03397198
## 7  0.12813370 0.8921723 0.8424778 0.02326732 0.03397198
## 8  0.14948932 0.8921723 0.8424778 0.02326732 0.03397198
## 9  0.17084494 0.8921723 0.8424778 0.02326732 0.03397198
## 10 0.19220056 0.6630268 0.4042284 0.19975184 0.40034135</code></pre>
<p>This printout shows us model performance for different values of the tuning parameter, cp. It seems for a high cp, we get a close to perfect model. Let’s take a look at this model. We could use the regular <code>plot</code> function, but the resulting tree looks ugly. The <code>prp</code> function from the <code>rpart.plot</code> package makes a much nicer tree (other packages to plot nice trees exist).</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb39-1" title="1"><span class="kw">prp</span>(fit1<span class="op">$</span>finalModel, <span class="dt">extra =</span> <span class="dv">1</span>, <span class="dt">type =</span> <span class="dv">1</span>)</a></code></pre></div>
<p><img src="Tree_Fitting_files/figure-html/printfigure-1.png" width="672" /></p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb40-1" title="1">ww=<span class="fl">17.8</span><span class="op">/</span><span class="fl">2.54</span>; wh=ww; <span class="co">#for saving plot</span></a>
<a class="sourceLine" id="cb40-2" title="2"><span class="kw">dev.print</span>(<span class="dt">device=</span>png,<span class="dt">width=</span>ww,<span class="dt">height=</span>wh,<span class="dt">units=</span><span class="st">&quot;in&quot;</span>,<span class="dt">res=</span><span class="dv">600</span>,<span class="dt">file=</span><span class="st">&quot;rparttree.png&quot;</span>) <span class="co">#save tree to file</span></a></code></pre></div>
<pre><code>## png 
##   2</code></pre>
<p>So the model splits on month, repeatedly. And it also splits on the hemisphere, which makes sense since the seasons are switched in the Southern hemisphere. This is also likely the reason why the model with month only didn’t produce a perfect fit. It could get one hemisphere right, but not both. With both bits of information, we can get almost perfect predictions.</p>
<p>Note two distinguishing features of this tree model: Even though we fed the algorithm the full model including all predictor variables, some - in fact, almost all - of them are not part of the final model. This is a good illustration of the feature/variable selection property that a tree does automatically. If it doesn’t find a certain predictor variable useful, it leaves it out.</p>
<p>Also, note that some predictor variables are used more than once. In fact, in this example, only 2 variables are used, and they are used repeatedly.</p>
<p>You can also see on each node the predictions for each outcome category at that step. It is always possible to build a tree that predicts perfectly, but that would lead to overfitting. That’s why we use cross-validation and tuning of the <code>cp</code> parameter, which reduces the risk of overfitting.</p>
<p>Finally, note that by default, levels are ordered alphabetically (Fall/Spring/Summer/Winter). We could re-order the factor manually in the more logical Spring/Summer/Fall/Winter order. I would do that for a ‘real’ analysis where I want to show a nice final result, but here we can leave it as is, as long as we pay attention to this fact.</p>
</div>
<div id="re-fitting-the-tree" class="section level1">
<h1>Re-fitting the tree</h1>
<p>So the above produces an almost perfect fit, and thus more powerful models are not really needed. However, using start (and end) month information seems a bit like cheating. Of course, if we give the model that kind of information, it will do well. Let’s make it harder and remove those 2 variables from both the training and test sets.</p>
<p>Also, further below, I had problems fitting some of the models, the NA caused problems. The issue often is that while the underlying algorithm can handle the missing values (as you saw above), when using wrappers like <code>caret</code>, things break down. I could either skip <code>caret</code> and try to access the different models directly. For now, I decided to go the other route and drop the data with the missing values. To be able to compare the different models below, I’m dropping those NA observations here. Since the data changed, we also need to re-do the null model computation to be able to compare properly.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb42-1" title="1"><span class="co">#write code that removes StartMonth and EndMonth from both training and test sets</span></a>
<a class="sourceLine" id="cb42-2" title="2"><span class="co"># then drop all observations with missing values in both trian and test sets</span></a>
<a class="sourceLine" id="cb42-3" title="3">data_test1 &lt;-<span class="st"> </span>data_test <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span><span class="kw">c</span>(StartMonth, EndMonth)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb42-4" title="4"><span class="st">  </span><span class="kw">drop_na</span>()</a>
<a class="sourceLine" id="cb42-5" title="5">data_train1 &lt;-<span class="st"> </span>data_train <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span><span class="kw">c</span>(StartMonth, EndMonth)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb42-6" title="6"><span class="st">  </span><span class="kw">drop_na</span>()</a>
<a class="sourceLine" id="cb42-7" title="7"><span class="co"># copy and paste the code from above that computes performance of a null model</span></a>
<a class="sourceLine" id="cb42-8" title="8"></a>
<a class="sourceLine" id="cb42-9" title="9">null_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="st">&quot;Winter&quot;</span>, <span class="kw">nrow</span>(data_train1))</a>
<a class="sourceLine" id="cb42-10" title="10"><span class="kw">measureACC</span>(null_<span class="dv">1</span>, data_train1<span class="op">$</span>season)</a></code></pre></div>
<pre><code>## [1] 0.4594595</code></pre>
<p>You should find a very similar null-model accuracy, around 0.46.</p>
<p>Now, let’s re-do the fit above fitting a single tree. I’ll increase the tuneLength value a bit so the algorithm can try a few more parameter values.</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb44-1" title="1"><span class="co">#copy and paste the code from above that fits the single tree. set tuneLength to 20. </span></a>
<a class="sourceLine" id="cb44-2" title="2"><span class="kw">set.seed</span>(<span class="dv">1111</span>) <span class="co">#makes each code block reproducible</span></a>
<a class="sourceLine" id="cb44-3" title="3">fitControl &lt;-<span class="st"> </span><span class="kw">trainControl</span>(<span class="dt">method=</span><span class="st">&quot;repeatedcv&quot;</span>,<span class="dt">number=</span><span class="dv">5</span>,<span class="dt">repeats=</span><span class="dv">5</span>) </a>
<a class="sourceLine" id="cb44-4" title="4">fit1 =<span class="st"> </span>caret<span class="op">::</span><span class="kw">train</span>(season  <span class="op">~</span><span class="st"> </span>., <span class="dt">data=</span>data_train1, <span class="dt">method=</span><span class="st">&quot;rpart&quot;</span>,  <span class="dt">trControl =</span> fitControl, <span class="dt">na.action =</span> na.pass, <span class="dt">tuneLength =</span> <span class="dv">20</span>) </a>
<a class="sourceLine" id="cb44-5" title="5"><span class="kw">print</span>(fit1<span class="op">$</span>results)</a></code></pre></div>
<pre><code>##             cp  Accuracy      Kappa  AccuracySD    KappaSD
## 1  0.000000000 0.4032447 0.10177258 0.041303906 0.04943246
## 2  0.001111111 0.4046733 0.10321890 0.039581294 0.04839754
## 3  0.002222222 0.4114946 0.10850598 0.043487145 0.05399774
## 4  0.003333333 0.4147643 0.11135985 0.043181556 0.05429909
## 5  0.004444444 0.4262870 0.11336398 0.051380613 0.06736817
## 6  0.005555556 0.4317022 0.11755598 0.051139509 0.06462923
## 7  0.006666667 0.4396270 0.12176007 0.051667794 0.06026214
## 8  0.007777778 0.4399842 0.12008785 0.050906264 0.06052192
## 9  0.008888889 0.4465234 0.11599739 0.047185923 0.05756015
## 10 0.010000000 0.4501401 0.11811836 0.049527798 0.05953667
## 11 0.011111111 0.4580816 0.11937927 0.047714289 0.05811014
## 12 0.012222222 0.4577375 0.10963520 0.047840251 0.06025071
## 13 0.013333333 0.4645878 0.09738409 0.032862455 0.06182462
## 14 0.014444444 0.4678310 0.09172884 0.026320628 0.06288125
## 15 0.015555556 0.4671265 0.06765252 0.023924246 0.06295119
## 16 0.016666667 0.4653083 0.06190639 0.020872963 0.06012611
## 17 0.017777778 0.4638701 0.05595835 0.020339676 0.05869470
## 18 0.018888889 0.4616748 0.04063065 0.016240474 0.04933952
## 19 0.020000000 0.4609444 0.03263836 0.011957108 0.04688284
## 20 0.021111111 0.4630905 0.02962767 0.009824699 0.04587217</code></pre>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb46-1" title="1"><span class="co"># look at model performance for different cp values. Also plot the tree.</span></a>
<a class="sourceLine" id="cb46-2" title="2"><span class="kw">prp</span>(fit1<span class="op">$</span>finalModel, <span class="dt">extra =</span> <span class="dv">1</span>, <span class="dt">type =</span> <span class="dv">1</span>)</a></code></pre></div>
<p><img src="Tree_Fitting_files/figure-html/fullfit-2-1.png" width="672" /></p>
<p>With those variables removed, the tree model doesn’t perform very well. Accuracy is similar to the null model. You can see that in the tree figure, the final nodes (leaves) show a lot of mis-predictions. Note again that only a few variables are used to build the tree, and OBYear shows up more than once.</p>
<p>Let’s see if we can get improved performance with more complicated models. That is, of course, not guaranteed. If there is no “signal” in the data, it doesn’t matter how complicated the model is. We won’t get anything predictive.</p>
</div>
<div id="random-forest" class="section level1">
<h1>Random forest</h1>
<p>Let’s try a random forest. We’ll use the <code>ranger</code> algorithm for this (it’s generally faster than the <code>rf</code> algorithm). This model has parameters that can and should be tuned. To do the tuning, we set up a grid of parameters and search over that grid. More efficient ways exist, e.g., doing an optimization using something like a genetic algorithm. The <code>mlr</code> package allows you to do that, <code>caret</code> doesn’t have those features out of the box, you would need to write your own code for that.</p>
<p>Note that running the code below (and several models that follow) might take a few seconds or minutes, depending on the speed of your computer.</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb47-1" title="1"><span class="kw">set.seed</span>(<span class="dv">1111</span>) <span class="co">#makes each code block reproducible</span></a>
<a class="sourceLine" id="cb47-2" title="2">tuning_grid &lt;-<span class="st"> </span><span class="kw">expand.grid</span>( <span class="dt">.mtry =</span> <span class="kw">seq</span>(<span class="dv">1</span>,<span class="dv">7</span>,<span class="dt">by=</span><span class="dv">1</span>), <span class="dt">.splitrule =</span> <span class="st">&quot;gini&quot;</span>, <span class="dt">.min.node.size =</span> <span class="kw">seq</span>(<span class="dv">2</span>,<span class="dv">8</span>,<span class="dt">by=</span><span class="dv">1</span>) )</a>
<a class="sourceLine" id="cb47-3" title="3">fit2 =<span class="st"> </span>caret<span class="op">::</span><span class="kw">train</span>(season <span class="op">~</span><span class="st"> </span>., <span class="dt">data=</span>data_train1, <span class="dt">method=</span><span class="st">&quot;ranger&quot;</span>,  <span class="dt">trControl =</span> fitControl, <span class="dt">tuneGrid =</span> tuning_grid, <span class="dt">na.action =</span> na.pass) </a></code></pre></div>
<p>We can’t plot a nice final tree anymore since the model is now a combination of trees. We can look at a plot of model performance as a function of the model tuning parameters.</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb48-1" title="1"><span class="kw">plot</span>(fit2)</a></code></pre></div>
<p><img src="Tree_Fitting_files/figure-html/randomforestresult-1.png" width="672" /></p>
<p>This plot suggests that for around 4 randomly selected parameters and a minimum node size of 6, we get the best model. Note that there isn’t much difference in model performance for several different values of the tuning parameters, and the overall model isn’t that great either, an accuracy just shy of 0.5.</p>
</div>
<div id="boosted-tree-ensemble" class="section level1">
<h1>Boosted tree ensemble</h1>
<p>Let’s now try a boosted regression tree ensemble. This method also has several parameters that need tuning, which are specified in <code>gbmGrid</code>.</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb49-1" title="1">gbmGrid &lt;-<span class="st"> </span><span class="kw">expand.grid</span>(<span class="dt">interaction.depth =</span> <span class="kw">seq</span>(<span class="dv">1</span>, <span class="dv">7</span>, <span class="dt">by =</span> <span class="dv">2</span>), <span class="dt">n.trees =</span> <span class="dv">300</span>, <span class="dt">shrinkage =</span> <span class="kw">c</span>(<span class="fl">0.1</span>, <span class="fl">0.01</span>), <span class="dt">n.minobsinnode =</span> <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">4</span>,<span class="dv">6</span>))</a>
<a class="sourceLine" id="cb49-2" title="2">fit3 =<span class="st"> </span>caret<span class="op">::</span><span class="kw">train</span>(season <span class="op">~</span><span class="st"> </span>., <span class="dt">data=</span>data_train1, <span class="dt">method=</span><span class="st">&quot;gbm&quot;</span>, <span class="dt">trControl =</span> fitControl, <span class="dt">verbose=</span><span class="ot">FALSE</span>, <span class="dt">tuneGrid =</span> gbmGrid) </a></code></pre></div>
<p>We can again look at diagnostic fits and variable importance plots for this model, as well as check performance.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb50-1" title="1"><span class="kw">plot</span>(fit3)</a></code></pre></div>
<p><img src="Tree_Fitting_files/figure-html/gbmresult-1.png" width="672" /></p>
<p>It doesn’t look like the boosted tree model performs any better. It may be that no information in the predictors strongly correlates with the season.</p>
<p>But let’s not give up yet, we’ll try a bit more. Let’s see if pre-processing helps.</p>
</div>
<div id="random-forest-with-pre-processed-predictors" class="section level1">
<h1>Random forest with pre-processed predictors</h1>
<p>Here, we’ll fit another random forest model but now use centering and scaling for the predictors.</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb51-1" title="1"><span class="co"># copy the random forest code from above. Add a statement to the train() function that centers and scales predictors.</span></a>
<a class="sourceLine" id="cb51-2" title="2"><span class="kw">set.seed</span>(<span class="dv">1111</span>) <span class="co">#makes each code block reproducible</span></a>
<a class="sourceLine" id="cb51-3" title="3">tuning_grid &lt;-<span class="st"> </span><span class="kw">expand.grid</span>( <span class="dt">.mtry =</span> <span class="kw">seq</span>(<span class="dv">1</span>,<span class="dv">7</span>,<span class="dt">by=</span><span class="dv">1</span>), <span class="dt">.splitrule =</span> <span class="st">&quot;gini&quot;</span>, <span class="dt">.min.node.size =</span> <span class="kw">seq</span>(<span class="dv">2</span>,<span class="dv">8</span>,<span class="dt">by=</span><span class="dv">1</span>) )</a>
<a class="sourceLine" id="cb51-4" title="4">fit4 =<span class="st"> </span>caret<span class="op">::</span><span class="kw">train</span>(season <span class="op">~</span><span class="st"> </span>., <span class="dt">data=</span>data_train1, <span class="dt">method=</span><span class="st">&quot;ranger&quot;</span>,  <span class="dt">trControl =</span> fitControl, <span class="dt">tuneGrid =</span> tuning_grid, <span class="dt">na.action =</span> na.pass,</a>
<a class="sourceLine" id="cb51-5" title="5">                    <span class="dt">preProcess=</span><span class="kw">c</span>(<span class="st">&quot;center&quot;</span>,<span class="st">&quot;scale&quot;</span>)) </a>
<a class="sourceLine" id="cb51-6" title="6"><span class="co"># save the result as fit4. plot model results.</span></a>
<a class="sourceLine" id="cb51-7" title="7"><span class="kw">plot</span>(fit4)</a></code></pre></div>
<p><img src="Tree_Fitting_files/figure-html/randomforest-2-1.png" width="672" /></p>
<p>It doesn’t look like it helped a lot.</p>
</div>
<div id="discriminant-analysis" class="section level1">
<h1>Discriminant analysis</h1>
<p>Ok, let’s try one more. Since the trees don’t seem to work too well, and a logistic model doesn’t work for multiple categorical outcomes, let’s use another model that can do that, namely a discriminant analysis. We’ve already seen one of those previously. Let’s pick a different one. The caret package website lists a lot of algorithms. I don’t know how exactly they all differ. Let’s try the one called penalized discriminant analysis (pda) (penalized is another way of saying regularized, and we learned that regularization might sometimes help.)</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb52-1" title="1"><span class="co">#write code that trains a pda model, use tuneLength 20. Save as fit5 and plot.</span></a>
<a class="sourceLine" id="cb52-2" title="2">pda_Grid &lt;-<span class="st"> </span><span class="kw">expand.grid</span>(<span class="dt">lambda=</span><span class="kw">seq</span>(<span class="dv">1</span>,<span class="dv">10</span>, <span class="dt">by=</span><span class="dv">1</span>))</a>
<a class="sourceLine" id="cb52-3" title="3">fit5 =<span class="st"> </span>caret<span class="op">::</span><span class="kw">train</span>(season <span class="op">~</span><span class="st"> </span>., <span class="dt">data=</span>data_train1, <span class="dt">method=</span><span class="st">&quot;pda&quot;</span>, <span class="dt">trControl =</span> fitControl, <span class="dt">tuneGrid =</span> pda_Grid)</a>
<a class="sourceLine" id="cb52-4" title="4"><span class="kw">plot</span>(fit5)</a></code></pre></div>
<p><img src="Tree_Fitting_files/figure-html/da-1.png" width="672" /></p>
<p>Ok, that doesn’t look very good either. Alright, enough models, there just doesn’t seem to be much information in the data that could help predict season. So let’s start to wrap up.</p>
</div>
<div id="comparing-model-performance" class="section level1">
<h1>Comparing model performance</h1>
<p>To recap: After we removed the obvious predictors, we fitted 1 tree, 1 random forest, 1 gradient boosted tree, 1 random forest with processed predictors, and 1 discriminant analysis. Let’s compare the performance.</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb53-1" title="1">resamps &lt;-<span class="st"> </span><span class="kw">resamples</span>(<span class="kw">list</span>(<span class="dt">tree =</span> fit1,</a>
<a class="sourceLine" id="cb53-2" title="2">                          <span class="dt">RF1 =</span> fit2,</a>
<a class="sourceLine" id="cb53-3" title="3">                          <span class="dt">GBM =</span> fit3,</a>
<a class="sourceLine" id="cb53-4" title="4">                          <span class="dt">RF2 =</span> fit4, </a>
<a class="sourceLine" id="cb53-5" title="5">                          <span class="dt">PDA =</span> fit5))</a>
<a class="sourceLine" id="cb53-6" title="6"><span class="kw">bwplot</span>(resamps)</a></code></pre></div>
<p><img src="Tree_Fitting_files/figure-html/randomforest-3-1.png" width="672" /></p>
<p>This plot suggests that while none of the models are great, the random forest ones seem overall slightly better.</p>
</div>
<div id="evaluating-the-final-model" class="section level1">
<h1>Evaluating the final model</h1>
<p>Even though we didn’t really have any good model, and thus further evaluating it seems, in some sense pointless, for this exercise we’ll look at our “best” model anyway. We’ll declare the 1st random forest model (saved as <code>fit2</code>) to be the best.</p>
<p>Model uncertainty in the predictions is shown in the previous plot.</p>
<p>For categorical outcomes, we can’t plot residuals. But we can look at the final “2x2” (in this case, a 4x4) table (the confusion matrix) and compare true versus predicted outcomes and see if it shows any pattern.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb54-1" title="1"><span class="co">#Write code to get model predictions for the outcome on the training data.</span></a>
<a class="sourceLine" id="cb54-2" title="2">pred&lt;-<span class="kw">predict</span>(fit4, data_train1)</a>
<a class="sourceLine" id="cb54-3" title="3"><span class="co">#use predicted and actual outcomes, make a table and compute accuracy.</span></a>
<a class="sourceLine" id="cb54-4" title="4"><span class="kw">table</span>(pred, data_train1<span class="op">$</span>season)</a></code></pre></div>
<pre><code>##         
## pred     Fall Spring Summer Winter
##   Fall     78      4      3      1
##   Spring    0    105      1      0
##   Summer    0      0     61      0
##   Winter   16     24      8    254</code></pre>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb56-1" title="1"><span class="kw">measureACC</span>(data_train1<span class="op">$</span>season, pred)</a></code></pre></div>
<pre><code>## [1] 0.8972973</code></pre>
<p>You should see that the model gets a lot right (high numbers on the diagonal), but predicts winter more often than it should (last row). Accuracy in the training data is pretty good.</p>
<p>But we know that performance on the training set is not that meaningful, especially with a complex model we always get fairly good performance on the data used to build the model. What matters is how it performs on new data, so let’s check that. We can look at the same for the test set, which is a better estimate of the true performance.</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb58-1" title="1"><span class="co">#copy and paste the code from above, but now do it for the test set.</span></a>
<a class="sourceLine" id="cb58-2" title="2"></a>
<a class="sourceLine" id="cb58-3" title="3">pred_test&lt;-<span class="kw">predict</span>(fit4, data_test1)</a>
<a class="sourceLine" id="cb58-4" title="4"></a>
<a class="sourceLine" id="cb58-5" title="5"><span class="kw">table</span>(pred_test, data_test1<span class="op">$</span>season)</a></code></pre></div>
<pre><code>##          
## pred_test Fall Spring Summer Winter
##    Fall     12      6      5     10
##    Spring    4      6      6      7
##    Summer    2      1      3      4
##    Winter   23     41     16     94</code></pre>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb60-1" title="1"><span class="kw">measureACC</span>(data_test1<span class="op">$</span>season, pred_test)</a></code></pre></div>
<pre><code>## [1] 0.4791667</code></pre>
<p>Here, the confusion matrix doesn’t look good at all. Off-diagonal entries are larger than diagonal, accuracy is about as good as a null model, and agrees with the cross-validated results. That last point is good, that means our cross-validation routine properly estimates the performance of “new” data. Of course, even this estimate on test data is a bit optimistic, since real new data is usually collected under slightly different circumstances and with different protocols, making it more likely that model performance is reduced.</p>
</div>
<div id="wrapping-up" class="section level1">
<h1>Wrapping up</h1>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb62-1" title="1"><span class="co"># shut down the parallel computing cluster we created at the beginning of the analysis</span></a>
<a class="sourceLine" id="cb62-2" title="2"><span class="kw">stopCluster</span>(cl)</a></code></pre></div>
<p>Overall, this suggests there is just no “signal” in the variables we are trying to use to predict the outcome, and the model fits to “noise” - thus doing ok on training data but failing on the test/cross-validated performance evaluation.</p>
<p>We can conclude that this is an analysis where we walk away “empty handed”. If this were a real analysis and you had data and did a ‘let’s see if something is going on’ analysis, this would be somewhat disappointing. If you had a specific, plausible hypothesis before you started your analysis (e.g., that outbreak size is correlated with season), finding that your biologically reasonable hypothesis doesn’t seem to be right is useful. Unfortunately, null results are still hard to publish.</p>
<p>Note that we didn’t use p-values here, but I bet we would have found several that are statistically significant <strong>when evaluated on the training data</strong> (as they usually are). But they would be meaningless and essentially “fitting the noise”. I contend that a lot of what’s published out there is exactly that, spurious p-values because models are evaluated on the training data.</p>
</div>
<div id="end-notes" class="section level1">
<h1>End notes</h1>
<p>Above, I kept search grids relatively small and specified other things (e.g., number of trees) to make sure things run reasonably fast. For a real project, I would make my searches and tuning more exhaustive, which might mean waiting a few hours for the code to run. If you want to, try to increase the search space or try different models to see if you can get a better performing model. It doesn’t seem to me that the data has any meaningful signal that would lead to a great model with much-improved performance. But you are welcome to see if you can find a model that performs better. If you do get a model that performs well (&gt;0.6 accuracy), let me know. I’d be curious to see it.</p>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = false;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
